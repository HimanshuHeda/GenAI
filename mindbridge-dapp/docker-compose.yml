version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: mindbridge-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: mindbridge
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
      MONGO_INITDB_DATABASE: mindbridge
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./scripts/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - mindbridge-network

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: mindbridge-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mindbridge-network

  # Backend API
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: mindbridge-backend
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      MONGODB_URI: mongodb://mindbridge:${MONGODB_PASSWORD}@mongodb:27017/mindbridge
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET}
      GOOGLE_CLOUD_PROJECT_ID: ${GOOGLE_CLOUD_PROJECT_ID}
      VERTEX_AI_REGION: ${VERTEX_AI_REGION}
      POLYGON_RPC_URL: ${POLYGON_RPC_URL}
      LIGHTNING_NODE_URI: ${LIGHTNING_NODE_URI}
    ports:
      - "4000:4000"
    depends_on:
      - mongodb
      - redis
    volumes:
      - ./apps/backend:/app
      - /app/node_modules
    networks:
      - mindbridge-network

  # Web Dashboard
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: mindbridge-web
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:4000
      NEXT_PUBLIC_BLOCKCHAIN_NETWORK: polygon-mumbai
      NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID: ${WALLET_CONNECT_PROJECT_ID}
    ports:
      - "3000:3000"
    depends_on:
      - backend
    volumes:
      - ./apps/web:/app
      - /app/node_modules
      - /app/.next
    networks:
      - mindbridge-network

  # IPFS Node
  ipfs:
    image: ipfs/kubo:latest
    container_name: mindbridge-ipfs
    ports:
      - "4001:4001"
      - "5001:5001"
      - "8080:8080"
    volumes:
      - ipfs_data:/data/ipfs
    networks:
      - mindbridge-network

  # Lightning Network Daemon (LND)
  lnd:
    image: lightninglabs/lnd:v0.17.0-beta
    container_name: mindbridge-lnd
    command:
      - "--bitcoin.active"
      - "--bitcoin.testnet"
      - "--bitcoin.node=bitcoind"
      - "--bitcoind.rpchost=bitcoind"
      - "--bitcoind.rpcuser=mindbridge"
      - "--bitcoind.rpcpass=${BITCOIN_RPC_PASSWORD}"
      - "--bitcoind.zmqpubrawblock=tcp://bitcoind:28332"
      - "--bitcoind.zmqpubrawtx=tcp://bitcoind:28333"
      - "--rpclisten=0.0.0.0:10009"
      - "--restlisten=0.0.0.0:8080"
      - "--listen=0.0.0.0:9735"
      - "--externalip=lnd"
    ports:
      - "9735:9735"
      - "10009:10009"
      - "8081:8080"
    volumes:
      - lnd_data:/root/.lnd
    depends_on:
      - bitcoind
    networks:
      - mindbridge-network

  # Bitcoin Core (Testnet)
  bitcoind:
    image: ruimarinho/bitcoin-core:23
    container_name: mindbridge-bitcoind
    command:
      - "-testnet=1"
      - "-server=1"
      - "-rpcuser=mindbridge"
      - "-rpcpassword=${BITCOIN_RPC_PASSWORD}"
      - "-rpcallowip=0.0.0.0/0"
      - "-rpcbind=0.0.0.0"
      - "-zmqpubrawblock=tcp://0.0.0.0:28332"
      - "-zmqpubrawtx=tcp://0.0.0.0:28333"
    ports:
      - "18332:18332"
      - "18333:18333"
      - "28332:28332"
      - "28333:28333"
    volumes:
      - bitcoin_data:/home/bitcoin/.bitcoin
    networks:
      - mindbridge-network

  # Prometheus Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: mindbridge-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - mindbridge-network

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: mindbridge-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - mindbridge-network

volumes:
  mongodb_data:
  redis_data:
  ipfs_data:
  lnd_data:
  bitcoin_data:
  prometheus_data:
  grafana_data:

networks:
  mindbridge-network:
    driver: bridge